---
name: $(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
trigger:
  branches:
    include:
      - feature
  paths:
    include:
      - azure_policy_monitor/*
    exclude:
    - 'README.md'
    - 'tests/*'
# pr:
#   branches:
#     include:
#       - main
#       - feature/*
#   paths:
#     exclude:
#     - 'README.md'
#     - 'tests/*'
variables:
  functionWorkingDirectory: 'azure_policy_monitor/function/'
stages:
- stage: test_and_build
  displayName: 'Test and Build'
  variables:
  - group: variables - dev
  jobs:
  - job: lint_tests
    displayName: Lint Tests
    pool:
      vmImage: ubuntu-latest
    steps:
    - script: |
        docker pull github/super-linter:latest
        docker run -e RUN_LOCAL=true -v $(System.DefaultWorkingDirectory):/tmp/lint github/super-linter
      displayName: 'Code Scan using GitHub Super-Linter'
  - job: Bicep_Validation
    displayName: ARM Deployment Validation
    dependsOn: lint_tests
    pool:
      vmImage: windows-latest
    steps:
    - task: AzureCLI@2
      displayName: 'Create Resource Group'
      inputs:
        azureSubscription: 'Azurepolicy_test_Subscription'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az --version
          az group create --name $(resourceGroupName) --location $(location)
    - task: AzureCLI@2
      displayName: 'Template Validation - Function App'
      inputs:
        azureSubscription: 'Azurepolicy_test_Subscription'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          az deployment group validate --resource-group $(resourceGroupName) --template-file "azure_policy_monitor/templates/function-app/main.bicep" --parameters logAnalyticsWorkspaceResourceId="$(logAnalyticsWorkspaceResourceId)" appInsightsName="$(appInsightsName)" appServicePlanName="$(appServicePlanName)" appServicePlanSku="$(appServicePlanSku)" functionAppName="$(functionAppName)" keyVaultName="$(keyVaultName)" keyVaultSku="$(keyVaultSku)" storageAccountName="$(storageAccountName)" storageSku="$(storageSku)"
    - task: AzureCLI@2
      displayName: 'Get Function App Template Deployment What-If Result'
      inputs:
        azureSubscription: 'Azurepolicy_test_Subscription'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          az deployment group what-if --resource-group $(resourceGroupName) --template-file "azure_policy_monitor/templates/function-app/main.bicep" --parameters logAnalyticsWorkspaceResourceId="$(logAnalyticsWorkspaceResourceId)" appInsightsName="$(appInsightsName)" appServicePlanName="$(appServicePlanName)" appServicePlanSku="$(appServicePlanSku)" functionAppName="$(functionAppName)" keyVaultName="$(keyVaultName)" keyVaultSku="$(keyVaultSku)" storageAccountName="$(storageAccountName)" storageSku="$(storageSku)"
    - task: AzureCLI@2
      displayName: 'Template Validation - Event Grid'
      inputs:
        azureSubscription: 'Azurepolicy_test_Subscription'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          az deployment group validate --resource-group $(resourceGroupName) --template-file "azure_policy_monitor/templates/event-grid/main.bicep"
    - task: AzureCLI@2
      displayName: 'Get Event Grid Template Deployment What-If Result'
      inputs:
        azureSubscription: 'Azurepolicy_test_Subscription'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          az deployment group what-if --resource-group $(resourceGroupName) --template-file "azure_policy_monitor/templates/event-grid/main.bicep" --result-format "FullResourcePayloads"
  - job: Build_Function_App
    displayName: Build Function App
    pool:
      vmImage: ubuntu-latest
    dependsOn: Bicep_Validation
    steps:
    - bash: |
        
        if [ -f extensions.csproj ]
        then
            dotnet build extensions.csproj --runtime ubuntu.16.04-x64 --output ./bin
        fi
      workingDirectory: $(functionWorkingDirectory)
      displayName: 'Build extensions'
   
    - task: UsePythonVersion@0
      displayName: 'Use Python 3.11'
      inputs:
        versionSpec: 3.11 # Functions V2 supports Python 3.6 as of today
    - bash: |
        pip install --target="./.python_packages/lib/site-packages" -r ./requirements.txt
      workingDirectory: $(functionWorkingDirectory)
      displayName: 'Install application dependencies'
    - task: ArchiveFiles@2
      displayName: 'Archive files'
      inputs:
        rootFolderOrFile: $(functionWorkingDirectory)
        includeRootFolder: false
        archiveType: zip
        archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
        replaceExistingArchive: true
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
      artifact: drop
  - job: Publish_Pattern
    displayName: Publish Pattern
    pool:
      vmImage: ubuntu-latest
    dependsOn: Build_Function_App
    steps:
    - task: CopyFiles@2
      displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
        CleanTargetFolder: true
        OverWrite: true
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact'
      inputs:
        artifactName: 'PolicyMonitor'
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
- stage: dev_deploy
  displayName: 'Deploy Dev Stage'
  jobs:
    - deployment: dev_function_app_deploy
      variables:
      - group: variables - dev
      displayName: 'Deploy Function App to Dev Managmenet Subscription'
      pool:
        vmImage: ubuntu-latest
        timeoutInMinutes: 60
      environment: 'dev'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureCLI@2
                displayName: 'Deploy Function App'
                inputs:
                  azureSubscription: 'Azurepolicy_test_Subscription'
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    az deployment group create --name "func-$(Build.BuildId)" --resource-group $(resourceGroupName) --template-file $(Agent.BuildDirectory)/PolicyMonitor/azure_policy_monitor/templates/function-app/main.bicep --parameters logAnalyticsWorkspaceResourceId="$(logAnalyticsWorkspaceResourceId)" appInsightsName="$(appInsightsName)" appServicePlanName="$(appServicePlanName)" appServicePlanSku="$(appServicePlanSku)" functionAppName="$(functionAppName)" keyVaultName="$(keyVaultName)" keyVaultSku="$(keyVaultSku)" storageAccountName="$(storageAccountName)" storageSku="$(storageSku)"
              - task: AzureFunctionApp@1
                displayName: 'Azure functions app deploy'
                inputs:
                  azureSubscription: 'Azurepolicy_test_Subscription'
                  appType: functionAppLinux
                  appName: $(functionAppName)
                  package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'
              - bash: |
                  sleep 120
                displayName: 'Wait 2 Minutes'
    - deployment: dev_event_grid_deploy_mgmt_sub
      variables:
      - group: variables - dev
      displayName: 'Deploy Event Grid Topic and Subscription to Dev Managmenet Subscription'
      pool:
        vmImage: ubuntu-latest
        timeoutInMinutes: 60
      dependsOn: dev_function_app_deploy
      environment: 'dev'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureCLI@2
                displayName: 'Deploy Event Grid'
                inputs:
                  azureSubscription: 'Azurepolicy_test_Subscription'
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    az provider register --namespace Microsoft.PolicyInsights
                    az provider register --namespace Microsoft.EventGrid
                    subId=$(az account show | jq '.id' | tr -d '"')
                    functionAppResourceId="/subscriptions/$(subscriptionid)/resourceGroups/$(resourceGroupName)/providers/Microsoft.Web/sites/$(functionAppName)/functions/PolicyMonitor"
                    az deployment group create --name "evtgrid-$(Build.BuildId)" --resource-group $(resourceGroupName) --template-file $(Agent.BuildDirectory)/PolicyMonitor/azure_policy_monitor/templates/event-grid/main.bicep --parameters eventGridSubName="$(eventGridSubName)" topicName="$(topicName)" functionAppResourceId=$functionAppResourceId
    